<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLACKBOX | 店員管理端</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #111827; color: white; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .btn-action { transition: all 0.2s; active: scale(0.95); }
    </style>
</head>
<body class="min-h-screen p-4 pb-20">

    <header class="flex justify-between items-center mb-6">
        <div>
            <p class="text-[10px] text-yellow-500 tracking-widest uppercase font-bold">STAFF ONLY</p>
            <h1 class="text-2xl font-black text-white">店員管理系統</h1>
        </div>
        <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center font-bold text-black">S</div>
    </header>

    <section class="mb-6 space-y-4">
        <div id="reader" class="w-full rounded-xl overflow-hidden bg-black hidden border-2 border-yellow-500"></div>
        
        <div class="flex gap-2">
            <input id="input-id" type="text" placeholder="輸入會員 ID 或掃描 QR" class="flex-1 bg-gray-800 border border-gray-700 text-white rounded-xl px-4 py-3 outline-none focus:border-yellow-500 transition">
            <button onclick="startScan()" class="bg-gray-700 text-white p-3 rounded-xl btn-action">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
            </button>
            <button onclick="searchMember()" class="bg-yellow-500 text-black px-6 rounded-xl font-bold btn-action">查詢</button>
        </div>
    </section>

    <div id="member-card" class="hidden animate-fade-in-up">
        <div class="glass-panel p-6 mb-6 border-l-4 border-yellow-500 relative">
            <button onclick="clearMember()" class="absolute top-4 right-4 text-gray-400 hover:text-white">✕</button>
            <p class="text-gray-400 text-xs mb-1">會員姓名</p>
            <h2 id="m-name" class="text-2xl font-black text-white mb-4">---</h2>
            
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-gray-400 text-xs mb-1">目前積分</p>
                    <p id="m-points" class="text-4xl font-black text-yellow-400 font-mono">0</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-400 text-xs mb-1">電話</p>
                    <p id="m-phone" class="text-sm font-mono text-white">---</p>
                </div>
            </div>
        </div>

        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-3 pl-1">積分操作</h3>
        <div class="grid grid-cols-2 gap-3 mb-8">
            <button onclick="updatePoints(100)" class="bg-green-600/20 text-green-400 border border-green-600/50 py-4 rounded-xl font-bold btn-action hover:bg-green-600 hover:text-white flex flex-col items-center">
                <span class="text-2xl mb-1">+100</span>
                <span class="text-xs opacity-70">消費累積</span>
            </button>
            <button onclick="updatePoints(-100)" class="bg-red-600/20 text-red-400 border border-red-600/50 py-4 rounded-xl font-bold btn-action hover:bg-red-600 hover:text-white flex flex-col items-center">
                <span class="text-2xl mb-1">-100</span>
                <span class="text-xs opacity-70">積分折抵</span>
            </button>
            
            <div class="col-span-2 flex gap-2 mt-2">
                <input id="custom-points" type="number" placeholder="輸入自訂數值 (負數為扣除)" class="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 text-white outline-none">
                <button onclick="submitCustomPoints()" class="bg-gray-700 text-white px-6 rounded-xl font-bold btn-action">執行</button>
            </div>
        </div>

        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-3 pl-1">持有優惠券</h3>
        <div id="coupon-list" class="space-y-3 pb-20">
            </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-600 border-t-yellow-500"></div>
    </div>

    <script>
        // --- 設定區 (請務必與 index.html 保持一致) ---
        const SUPABASE_URL = 'https://nszwpwimwxvjguoalzwt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zendwd2ltd3h2amd1b2Fsend0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzY1NzYsImV4cCI6MjA4MTcxMjU3Nn0.TaAt4aqEhDsONWtDCagD5rlTMknEWfhq8fMVL1Rt4lg';
        // ------------------------------------------

        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentMember = null;
        let html5QrCode = null;

        // 1. 查詢會員
        async function searchMember() {
            const input = document.getElementById('input-id').value.trim();
            // 處理掃描到的格式 (例如: BBX-xxxx 或 CPN-xxxx)
            let queryId = input;
            
            // 如果是會員碼 (BBX-)
            if (input.startsWith('BBX-')) {
                queryId = input.replace('BBX-', '');
            } 
            // 如果是優惠券碼 (CPN-) -> 我們這裡先只查會員，優惠券核銷可以直接在查到會員後操作
            else if (input.startsWith('CPN-')) {
                alert("請先掃描會員卡，再核銷優惠券");
                return;
            }

            if (!queryId) return alert('請輸入 ID');

            showLoading(true);
            
            // 從 profiles 資料表抓人
            const { data, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('line_id', queryId)
                .single();

            showLoading(false);

            if (error || !data) {
                alert('找不到此會員資料！');
                clearMember();
            } else {
                currentMember = data;
                renderMember(data);
                loadCoupons(data.line_id);
                // 停止掃描器
                if (html5QrCode) {
                    try { await html5QrCode.stop(); document.getElementById('reader').classList.add('hidden'); } catch(e){}
                }
            }
        }

        // 2. 顯示會員資料
        function renderMember(data) {
            document.getElementById('m-name').innerText = data.full_name;
            document.getElementById('m-phone').innerText = data.phone;
            document.getElementById('m-points').innerText = data.total_points;
            document.getElementById('member-card').classList.remove('hidden');
        }

        // 3. 讀取優惠券
        async function loadCoupons(lineId) {
            const list = document.getElementById('coupon-list');
            list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">讀取中...</p>';

            const { data, error } = await _supabase
                .from('user_coupons')
                .select('*')
                .eq('line_id', lineId)
                .eq('status', 'unused') // 只顯示未使用的
                .order('created_at', { ascending: false });

            if (!data || data.length === 0) {
                list.innerHTML = '<p class="text-gray-600 text-sm text-center py-4">無可用優惠券</p>';
                return;
            }

            list.innerHTML = data.map(c => `
                <div class="bg-gray-800 rounded-xl p-4 flex justify-between items-center border border-gray-700">
                    <div>
                        <h4 class="font-bold text-white">${c.coupon_name}</h4>
                        <p class="text-xs text-gray-400">${c.valid_until || '永久有效'}</p>
                    </div>
                    <button onclick="redeemCoupon('${c.id}')" class="bg-yellow-500 text-black text-xs font-bold px-3 py-2 rounded-lg active:scale-95 transition">
                        核銷使用
                    </button>
                </div>
            `).join('');
        }

        // --- 核心邏輯：更新積分 (包含防負分機制) ---
        async function updatePoints(changeAmount) {
            if (!currentMember) return;

            const currentPoints = currentMember.total_points || 0;
            const newPoints = currentPoints + parseInt(changeAmount);

            // [重要] 防負分檢查！
            if (newPoints < 0) {
                alert(`❌ 操作失敗！\n\n會員目前只有 ${currentPoints} 點\n扣除 ${Math.abs(changeAmount)} 點後會變成負數。`);
                return; // 直接中斷，不執行後續動作
            }

            if (!confirm(`確認要變更積分嗎？\n\n變動：${changeAmount > 0 ? '+' : ''}${changeAmount}\n變更後：${newPoints}`)) return;

            showLoading(true);

            // 1. 更新 profiles 表
            const { error: updateError } = await _supabase
                .from('profiles')
                .update({ total_points: newPoints })
                .eq('line_id', currentMember.line_id);

            if (updateError) {
                alert("更新失敗：" + updateError.message);
                showLoading(false);
                return;
            }

            // 2. 寫入 point_logs 表 (留存紀錄)
            await _supabase.from('point_logs').insert({
                line_id: currentMember.line_id,
                points_change: parseInt(changeAmount),
                reason: changeAmount > 0 ? '店員手動增加' : '店員手動折抵',
                created_at: new Date().toISOString()
            });

            showLoading(false);
            alert("✅ 積分更新成功！");
            
            // 重新整理資料
            searchMember(); 
        }

        function submitCustomPoints() {
            const val = document.getElementById('custom-points').value;
            if (!val) return;
            updatePoints(val);
        }

        // --- 核心邏輯：核銷優惠券 ---
        async function redeemCoupon(couponId) {
            if (!confirm("確定要核銷這張優惠券嗎？此操作無法復原。")) return;

            showLoading(true);

            const { error } = await _supabase
                .from('user_coupons')
                .update({ status: 'used', used_at: new Date().toISOString() })
                .eq('id', couponId);

            showLoading(false);

            if (error) {
                alert("核銷失敗：" + error.message);
            } else {
                alert("✅ 優惠券已核銷！");
                loadCoupons(currentMember.line_id); // 重新讀取列表
            }
        }

        // --- 掃描器邏輯 ---
        function startScan() {
            const reader = document.getElementById('reader');
            reader.classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // 掃描成功
                    document.getElementById('input-id').value = decodedText;
                    searchMember(); // 自動查詢
                },
                (errorMessage) => { /* 掃描中... */ }
            ).catch(err => {
                alert("無法啟動相機，請確認權限或使用 https 連線");
                reader.classList.add('hidden');
            });
        }

        function clearMember() {
            currentMember = null;
            document.getElementById('member-card').classList.add('hidden');
            document.getElementById('input-id').value = '';
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
