<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘ç›’å­æœƒå“¡ç©åˆ†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 pb-24">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg relative">
        
        <div id="loading" class="flex justify-center items-center h-screen">
            <p class="text-gray-400 animate-pulse">æ­£åœ¨é€£ç·šè‡³é»‘ç›’å­ç³»çµ±...</p>
        </div>

        <main id="tab-home" class="hidden p-4 space-y-6">
            <header class="flex justify-center py-4">
                <h1 class="text-lg font-bold text-gray-800">ä¸»é </h1>
            </header>
            <div class="aspect-video bg-gray-100 rounded-3xl flex items-center justify-center text-gray-300">
                Banner å»£å‘Šå€åŸŸ
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window.location.href='https://www.blackbox-repair.com.tw/'" class="flex items-center justify-center gap-2 border py-4 rounded-2xl shadow-sm text-sm">
                    ğŸ” ç¶­ä¿®åƒ¹æ ¼
                </button>
                <button onclick="window.location.href='https://www.blackbox-repair.com.tw/locations/'" class="flex items-center justify-center gap-2 border py-4 rounded-2xl shadow-sm text-sm">
                    â“˜ æœå‹™æ“šé»
                </button>
            </div>
        </main>

        <main id="tab-member" class="hidden p-4">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-bold">æˆ‘çš„æœƒå“¡</h1>
                <button onclick="handleLogout()" class="text-xs text-gray-400 border px-2 py-1 rounded">ç™»å‡º</button>
            </header>

            <div class="bg-gradient-to-br from-gray-800 to-black text-white p-6 rounded-[2rem] shadow-xl mb-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] opacity-70 uppercase tracking-widest">Member Level</p>
                        <h2 id="m-level" class="text-xl font-bold">---</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] opacity-70 uppercase tracking-widest">ç©åˆ†é»æ•¸</p>
                        <p id="m-points" class="text-3xl font-mono font-bold text-yellow-400">0</p>
                    </div>
                </div>
                <div class="mt-8">
                    <p id="m-name" class="text-lg font-medium">è¼‰å…¥ä¸­...</p>
                    <p id="m-phone" class="text-sm opacity-60">---</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl border border-gray-100 text-center mb-8">
                <p class="text-gray-400 mb-4 text-[10px]">çµå¸³æ™‚è«‹å‡ºç¤ºæ­¤ç¢¼çµ¦åº—å“¡æƒæ</p>
                <div class="flex justify-center">
                    <canvas id="qr-code"></canvas>
                </div>
            </div>

            <h3 class="font-bold mb-3 flex items-center gap-2">ğŸŸï¸ æˆ‘çš„å„ªæƒ åˆ¸ <span id="coupon-count" class="text-xs bg-gray-100 px-2 rounded-full text-gray-500">0</span></h3>
            <div id="coupon-list" class="space-y-3 text-sm text-gray-400 text-center py-10">
                ç›®å‰å°šç„¡å¯ç”¨å„ªæƒ åˆ¸
            </div>
        </main>

        <nav class="fixed bottom-6 left-0 right-0 max-w-[320px] mx-auto flex justify-around py-3 bg-white/90 backdrop-blur-md border border-gray-100 rounded-full shadow-lg z-50">
            <button onclick="switchTab('home')" id="btn-home" class="flex flex-col items-center gap-1">
                <span class="text-xl">ğŸ </span><span class="text-[10px] text-gray-500">ä¸»é </span>
            </button>
            <button onclick="window.location.href='https://blackbox3c.simplybook.asia/v2/'" class="flex flex-col items-center gap-1">
                <span class="text-xl">ğŸ“</span><span class="text-[10px] text-gray-500">ç·šä¸Šé ç´„</span>
            </button>
            <button onclick="switchTab('member')" id="btn-member" class="flex flex-col items-center gap-1">
                <span class="text-xl">ğŸ‘¤</span><span class="text-[10px] text-gray-500">æˆ‘çš„æœƒå“¡</span>
            </button>
        </nav>
    </div>

    <script>
        const SUPABASE_URL = 'https://nszwpwimwxvjguoalzwt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_bIqoSDyBrvU7NJOc0Dr47A_LcO0xk3M';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            
            if (!session) {
                // å¦‚æœæ²’ç™»å…¥ï¼Œå˜—è©¦å°å‘ LINE ç™»å…¥
                // æ³¨æ„ï¼šåœ¨ GitHub Pages ä½¿ç”¨ï¼ŒredirectTo å¿…é ˆå¡«å¯«æ‚¨çš„é¦–é ç¶²å€
                await _supabase.auth.signInWithOAuth({ 
                    provider: 'line',
                    options: { redirectTo: window.location.origin + window.location.pathname }
                });
                return;
            }

            const user = session.user;

            // æŠ“å–æœƒå“¡è³‡æ–™
            const { data: profile } = await _supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profile) {
                document.getElementById('m-name').innerText = profile.full_name || user.user_metadata.full_name || 'é»‘ç›’å­æœƒå“¡';
                document.getElementById('m-points').innerText = profile.total_points || 0;
                document.getElementById('m-level').innerText = profile.member_level || 'ä¸€èˆ¬æœƒå“¡';
                document.getElementById('m-phone').innerText = profile.phone || 'å°šæœªç¶å®šé›»è©±';
                
                new QRious({
                    element: document.getElementById('qr-code'),
                    value: user.id,
                    size: 160
                });
            }

            document.getElementById('loading').classList.add('hidden');
            switchTab('home'); // ç™»å…¥å¾Œé è¨­é€²ä¸»é 
        }

        function switchTab(tab) {
            document.getElementById('tab-home').classList.toggle('hidden', tab !== 'home');
            document.getElementById('tab-member').classList.toggle('hidden', tab !== 'member');
            
            // è™•ç†åœ–æ¨™äº®åº¦
            document.getElementById('btn-home').style.opacity = tab === 'home' ? '1' : '0.4';
            document.getElementById('btn-member').style.opacity = tab === 'member' ? '1' : '0.4';
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            window.location.reload();
        }

        init();
    </script>
</body>
</html>
