<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BLACKBOX | æ‰‹æ©Ÿç¶­ä¿®ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; color: white; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        
        /* é»‘é‡‘æœƒå“¡å¡ */
        .card-black-gold { background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%); border: 1px solid #333; box-shadow: 0 10px 30px -10px rgba(234, 179, 8, 0.15); border-radius: 24px; position: relative; overflow: hidden; }
        .card-shine { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 40%, rgba(255,215,0,0.05) 50%, transparent 60%); pointer-events: none; }
        
        /* å„ªæƒ åˆ¸æ¨£å¼ */
        .coupon-ticket { background: #111; border: 1px solid #333; border-radius: 16px; position: relative; overflow: hidden; transition: transform 0.2s; margin-bottom: 12px; }
        .coupon-ticket:active { transform: scale(0.98); }
        .coupon-left { padding: 20px; border-right: 2px dashed #333; position: relative; }
        .coupon-left::after, .coupon-left::before { content: ''; position: absolute; width: 16px; height: 16px; background: #000; border-radius: 50%; right: -9px; z-index: 10; }
        .coupon-left::before { top: -8px; } .coupon-left::after { bottom: -8px; }
        .coupon-tag { font-size: 10px; color: #000; background: #eab308; padding: 2px 8px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 6px; }
        
        /* åº•éƒ¨å°èˆª */
        .nav-blur { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { color: #666; transition: all 0.3s; }
        .nav-item.active { color: #eab308; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        
        /* Loading */
        .loader { border: 3px solid #333; border-top: 3px solid #eab308; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* è¨»å†Šå½ˆçª— */
        .modal-bg { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .input-dark { background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; transition: border 0.3s; }
        .input-dark:focus { border-color: #eab308; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="register-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 modal-bg hidden">
        <div class="bg-[#111] border border-[#333] w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <h2 class="text-2xl font-black text-white mb-2 text-center">WELCOME</h2>
            <p class="text-gray-500 text-xs text-center mb-8 tracking-widest">BLACKBOX MEMBER</p>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 ml-1 block mb-1">æ‚¨çš„å§“å</label>
                    <input type="text" id="reg-name" class="input-dark" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1 block mb-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                    <input type="tel" id="reg-phone" class="input-dark" placeholder="09xxxxxxxx" maxlength="10">
                </div>
                <button onclick="registerUser()" class="w-full bg-[#eab308] text-black font-black py-4 rounded-xl mt-4 hover:bg-yellow-400 transition shadow-lg shadow-yellow-900/20">
                    ç«‹å³å•Ÿç”¨æœƒå“¡
                </button>
            </div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto pb-24 scroll-smooth">
        
        <div id="page-home" class="p-6 space-y-8 animate-fade-in">
            <header class="flex justify-between items-center mt-2">
                <div>
                    <p class="text-xs text-yellow-600 font-bold tracking-widest mb-1">HELLO,</p>
                    <h1 id="display-name" class="text-2xl font-black">è¼‰å…¥ä¸­...</h1>
                </div>
                <div class="w-10 h-10 rounded-full bg-[#222] border border-[#333] flex items-center justify-center">
                    <span class="text-yellow-500 text-xl">â˜…</span>
                </div>
            </header>

            <div class="card-black-gold p-6 min-h-[200px] flex flex-col justify-between">
                <div class="card-shine"></div>
                <div class="flex justify-between items-start z-10">
                    <img src="https://cdn-icons-png.flaticon.com/512/686/686655.png" class="w-8 opacity-50 invert">
                    <span class="text-[10px] bg-white/10 px-3 py-1 rounded-full border border-white/10 backdrop-blur-md">VIP MEMBER</span>
                </div>
                
                <div class="text-center z-10 py-4">
                     <div id="qrcode" class="bg-white p-2 rounded-xl inline-block shadow-lg"></div>
                    <p class="text-[10px] text-gray-500 mt-2 tracking-widest font-mono">SCAN FOR SERVICE</p>
                </div>

                <div class="z-10">
                    <p class="text-xs text-gray-500 mb-1">Total Points</p>
                    <p id="display-points" class="text-4xl font-black text-yellow-500 tracking-tighter">0</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <a href="https://blackbox3c.simplybook.asia/v2/" target="_blank" class="bg-[#1a1a1a] p-5 rounded-2xl border border-[#333] active:scale-95 transition flex flex-col items-center gap-2 group">
                    <span class="text-2xl group-hover:scale-110 transition">ğŸ“…</span>
                    <span class="text-sm font-bold text-gray-300">ç·šä¸Šé ç´„</span>
                </a>
                <div onclick="switchPage('coupons')" class="bg-[#1a1a1a] p-5 rounded-2xl border border-[#333] active:scale-95 transition flex flex-col items-center gap-2 group cursor-pointer">
                    <span class="text-2xl group-hover:scale-110 transition">ğŸŸï¸</span>
                    <span class="text-sm font-bold text-gray-300">æˆ‘çš„ç¥¨åˆ¸</span>
                </div>
            </div>
        </div>

        <div id="page-coupons" class="p-6 hidden animate-fade-in">
            <h2 class="text-2xl font-black mb-6">æˆ‘çš„ç¥¨åˆ¸</h2>
            
            <div id="coupon-list" class="space-y-4">
                <div class="text-center py-10">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-600 text-xs">æ­£åœ¨è®€å–ç¥¨å¤¾...</p>
                </div>
            </div>
        </div>

        <div id="page-locations" class="p-6 hidden animate-fade-in">
            <h2 class="text-2xl font-black mb-6">æœå‹™æ“šé»</h2>
            
            <div class="space-y-6">
                <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-[#333]">
                    <h3 class="text-yellow-500 font-bold text-lg mb-2">å‹¤ç¾å…¬ç›Šåº—</h3>
                    <p class="text-gray-400 text-sm mb-4 leading-relaxed">å°ä¸­å¸‚è¥¿å€å…¬ç›Šè·¯145è™Ÿ<br>(è¿‘å‹¤ç¾èª å“åŠNOVA)</p>
                    <div class="flex gap-3">
                        <a href="tel:0423015157" class="flex-1 bg-[#333] py-2 rounded-lg text-center text-xs font-bold hover:bg-[#444]">æ’¥æ‰“é›»è©±</a>
                        <a href="https://maps.google.com/?q=å°ä¸­å¸‚è¥¿å€å…¬ç›Šè·¯145è™Ÿ" target="_blank" class="flex-1 bg-white text-black py-2 rounded-lg text-center text-xs font-bold">å°èˆªå‰å¾€</a>
                    </div>
                </div>

                <div class="bg-[#1a1a1a] p-6 rounded-2xl border border-[#333]">
                    <h3 class="text-yellow-500 font-bold text-lg mb-2">æ²™é¹¿ç«™å‰åº—</h3>
                    <p class="text-gray-400 text-sm mb-4 leading-relaxed">å°ä¸­å¸‚æ²™é¹¿å€æ²™ç”°è·¯149è™Ÿ<br>(è¿‘æ²™é¹¿è»Šç«™)</p>
                    <div class="flex gap-3">
                        <a href="tel:0426633009" class="flex-1 bg-[#333] py-2 rounded-lg text-center text-xs font-bold hover:bg-[#444]">æ’¥æ‰“é›»è©±</a>
                        <a href="https://maps.google.com/?q=å°ä¸­å¸‚æ²™é¹¿å€æ²™ç”°è·¯149è™Ÿ" target="_blank" class="flex-1 bg-white text-black py-2 rounded-lg text-center text-xs font-bold">å°èˆªå‰å¾€</a>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full nav-blur flex justify-around py-4 z-40">
        <button onclick="switchPage('home')" class="nav-item active flex flex-col items-center" id="nav-home">
            <span class="nav-icon">ğŸ </span>
            <span class="text-[10px] font-bold">é¦–é </span>
        </button>
        <button onclick="switchPage('coupons')" class="nav-item flex flex-col items-center" id="nav-coupons">
            <span class="nav-icon">ğŸŸï¸</span>
            <span class="text-[10px] font-bold">ç¥¨åˆ¸</span>
        </button>
        <button onclick="switchPage('locations')" class="nav-item flex flex-col items-center" id="nav-locations">
            <span class="nav-icon">ğŸ“</span>
            <span class="text-[10px] font-bold">æ“šé»</span>
        </button>
    </nav>

    <script>
        // è¨­å®š Supabase
        const SUPABASE_URL = 'https://nszwpwimwxvjguoalzwt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zendwd2ltd3h2amd1b2Fsend0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzY1NzYsImV4cCI6MjA4MTcxMjU3Nn0.TaAt4aqEhDsONWtDCagD5rlTMknEWfhq8fMVL1Rt4lg';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // LIFF è¨­å®š (è«‹æ›æˆæ‚¨çš„ LIFF ID)
        const LIFF_ID = '2006696468-1Z25Lp7o'; 
        let userLineId = '';
        let userDisplayName = '';

        // åˆå§‹åŒ–
        window.onload = async function() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            userLineId = profile.userId;
            userDisplayName = profile.displayName;
            
            checkMemberStatus();
        };

        // æª¢æŸ¥æœƒå“¡ç‹€æ…‹
        async function checkMemberStatus() {
            const { data, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('line_id', userLineId)
                .single();

            if (!data) {
                // æœªè¨»å†Š -> é¡¯ç¤ºè¨»å†Šå½ˆçª—
                document.getElementById('register-modal').classList.remove('hidden');
            } else {
                // å·²è¨»å†Š -> é¡¯ç¤ºè³‡æ–™
                document.getElementById('display-name').innerText = data.full_name;
                document.getElementById('display-points').innerText = (data.total_points || 0).toLocaleString();
                generateQRCode(userLineId);
                
                // é †ä¾¿é è¼‰å„ªæƒ åˆ¸
                loadUserCoupons();
            }
        }

        // è¨»å†Šé‚è¼¯
        async function registerUser() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            
            if (!name || !phone) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }

            const { error } = await _supabase.from('profiles').insert({
                line_id: userLineId,
                full_name: name,
                phone: phone,
                total_points: 0
            });

            if (error) {
                if(error.code === '23505') alert('æ­¤é›»è©±è™Ÿç¢¼å·²è¢«è¨»å†Šï¼');
                else alert('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } else {
                alert('è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥é»‘ç›’å­');
                document.getElementById('register-modal').classList.add('hidden');
                checkMemberStatus();
            }
        }

        // ç”¢ç”Ÿ QR Code
        function generateQRCode(text) {
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: "BBX-" + text, // æ ¼å¼ï¼šBBX-LineID
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // é é¢åˆ‡æ›é‚è¼¯
        function switchPage(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            document.getElementById('page-home').classList.add('hidden');
            document.getElementById('page-coupons').classList.add('hidden');
            document.getElementById('page-locations').classList.add('hidden');
            
            // å–æ¶ˆå°èˆªäº®ç‡ˆ
            document.getElementById('nav-home').classList.remove('active');
            document.getElementById('nav-coupons').classList.remove('active');
            document.getElementById('nav-locations').classList.remove('active');

            // é¡¯ç¤ºç›®æ¨™é é¢
            document.getElementById('page-' + pageId).classList.remove('hidden');
            document.getElementById('nav-' + pageId).classList.add('active');

            // å¦‚æœåˆ‡åˆ°å„ªæƒ åˆ¸é ï¼Œé‡æ–°è®€å–ä¸€æ¬¡
            if(pageId === 'coupons') {
                loadUserCoupons();
            }
        }

        // --- è®€å–å®¢æˆ¶ç¥¨å¤¾ (é—œéµæ–°å¢åŠŸèƒ½) ---
        async function loadUserCoupons() {
            const list = document.getElementById('coupon-list');
            // è®€å–æ™‚é¡¯ç¤º loading (å¦‚æœä¸æ¸…ç©ºï¼Œå¯ä»¥åšæˆéœé»˜æ›´æ–°)
            
            const today = new Date().toISOString().split('T')[0];

            // æŸ¥è©¢æ¢ä»¶ï¼š 1. æˆ‘çš„ LineID 2. ç‹€æ…‹ unused
            const { data, error } = await _supabase
                .from('user_coupons')
                .select('*')
                .eq('line_id', userLineId)
                .eq('status', 'unused')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                list.innerHTML = '<p class="text-center text-gray-500 text-xs mt-10">ç„¡æ³•è®€å–ç¥¨å¤¾</p>';
                return;
            }

            // éæ¿¾éæœŸ (å¦‚æœåœ¨ DB ç«¯æ²’åšéæ¿¾çš„è©±)
            // é‚è¼¯ï¼š(æ²’æœŸé™) OR (æœŸé™ >= ä»Šå¤©)
            const validCoupons = data.filter(c => !c.valid_until || c.valid_until >= today);

            if (validCoupons.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 opacity-50">
                        <span class="text-4xl block mb-2">ğŸ«</span>
                        <p class="text-gray-400 text-sm">ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</p>
                    </div>`;
                return;
            }

            // æ¸²æŸ“åˆ—è¡¨
            list.innerHTML = validCoupons.map(coupon => {
                let dateHtml = '';
                if (coupon.valid_until) {
                    dateHtml = `<p class="text-[10px] text-gray-500 mt-1">æœ‰æ•ˆæœŸé™ï¼š${coupon.valid_until}</p>`;
                } else {
                    dateHtml = `<p class="text-[10px] text-gray-500 mt-1">æ°¸ä¹…æœ‰æ•ˆ</p>`;
                }

                return `
                <div class="coupon-ticket flex">
                    <div class="coupon-left bg-[#1a1a1a] flex flex-col justify-center items-start min-w-[80px]">
                        <span class="text-2xl">ğŸ</span>
                    </div>
                    <div class="p-4 flex-1 bg-[#1a1a1a] flex flex-col justify-center">
                        <span class="coupon-tag">æœªä½¿ç”¨</span>
                        <h3 class="text-white font-bold text-lg leading-tight mb-1">${coupon.coupon_name}</h3>
                        <p class="text-gray-400 text-xs">${coupon.description || 'åº—å“¡å°ˆå±¬å„ªæƒ '}</p>
                        ${dateHtml}
                    </div>
                </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
