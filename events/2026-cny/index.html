<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>新春好運三響砲 (除錯模式)</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
  
  /* 除錯用的登入框 */
  #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
  .login-card { background: #fff; color: #333; width: 85%; max-width: 350px; padding: 25px; border-radius: 16px; text-align: center; }
  .user-list { max-height: 300px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; text-align: left; }
  .user-btn { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
  .user-btn:active { background: #f0f0f0; }
  
  /* 遊戲場景 (簡化) */
  .scene-container { position: relative; width: 100%; height: 100%; background: url('tree_bg.jpg') center bottom / cover; }
  .wealth-horse { position: absolute; bottom: 2.5%; left: -3%; width: 45vw; max-width: 280px; z-index: 100; cursor: pointer; }
  .lion-wrapper { position: absolute; bottom: -5%; right: -8%; width: 58vw; max-width: 360px; z-index: 100; cursor: pointer; display: flex; justify-content: center; }
  .stone-lion { width: 100%; height: auto; }

  /* 彈窗 */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.4); backdrop-filter: blur(8px); z-index: 999; justify-content: center; align-items: center; }
  .modal-content { background: #fff; width: 75%; max-width: 320px; padding: 35px 25px; border-radius: 24px; text-align: center; box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15); animation: popIn 0.4s; }
  @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  .btn-confirm { background: #8d6e63; color: white; border: none; padding: 12px 35px; border-radius: 50px; font-size: 1rem; margin-top: 15px; }
</style>
</head>
<body>

<div id="loginOverlay">
  <div class="login-card">
    <h3>測試員登入 (除錯版)</h3>
    <div id="statusMsg" style="color: #06C755;">正在連線資料庫...</div>
    <div id="userList" class="user-list"></div>
    <div style="font-size:0.8rem; color:#999; margin-top:10px;">如果卡住，請用無痕視窗開啟</div>
  </div>
</div>

<div class="scene-container">
  <img src="wealth_horse.png" class="wealth-horse" onclick="openWealthModal()">
  <div class="lion-wrapper" onclick="alert('請先登入')"><img src="lion.png" class="stone-lion"></div>
</div>

<div class="modal-overlay" id="resultModal" onclick="this.style.display='none'">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div style="color:#999">恭喜獲得</div>
    <div id="prizeText" style="font-size:1.5rem; font-weight:bold; color:#5d4037; margin:10px 0;">...</div>
    <button class="btn-confirm" onclick="document.getElementById('resultModal').style.display='none'">收下好運</button>
  </div>
</div>

<div class="modal-overlay" id="wealthModal" onclick="this.style.display='none'">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div style="font-size:1.5rem; font-weight:bold; margin-bottom:15px;">財富密馬</div>
    <div>活動期間：2026.02.01 - 02.28<br>期間來店維修任一設備零件即可獲得</div>
    <button class="btn-confirm" onclick="document.getElementById('wealthModal').style.display='none'">我知道了</button>
  </div>
</div>

<script>
  // 1. 設定
  const SUPABASE_URL = 'https://nszwpwimwxvjguoalrwt.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zendwd2ltd3h2amd1b2Fsend0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzY1NzYsImV4cCI6MjA4MTcxMjU3Nn0.TaAt4aqEhDsONWtDCagD5rlTMknEWfhq8fMVL1Rt4lg';
  
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let CURRENT_USER_ID = null;

  // 2. 登入：只抓取最基本的欄位，避免報錯
  async function initLogin() {
    const listDiv = document.getElementById('userList');
    const statusMsg = document.getElementById('statusMsg');

    try {
      // 安全查詢：只查 id 和 line_id
      const { data, error } = await supabase
        .from('profiles')
        .select('id, line_id') 
        .not('line_id', 'is', null)
        .limit(20);

      if (error) {
        throw error; // 拋出錯誤讓下面 catch 抓到
      }

      if (!data || data.length === 0) {
        statusMsg.style.color = 'orange';
        statusMsg.innerText = '連線成功，但沒找到綁定 LINE 的會員';
        return;
      }

      // 成功讀取
      statusMsg.style.display = 'none';
      let html = '';
      data.forEach(user => {
        html += `
          <div class="user-btn" onclick="selectUser('${user.id}')">
            <span style="font-weight:bold; color:#06C755;">LINE:</span> ${user.line_id.substring(0,10)}...
            <br><span style="font-size:0.8rem; color:#999;">ID: ${user.id}</span>
          </div>`;
      });
      listDiv.innerHTML = html;

    } catch (err) {
      // 【強力報錯】直接把錯誤代碼顯示出來
      console.error(err);
      statusMsg.style.color = 'red';
      statusMsg.innerHTML = `
        <strong>讀取失敗!</strong><br>
        錯誤代碼: ${err.code || '未知'}<br>
        錯誤訊息: ${err.message}<br>
        <small>(請截圖此畫面給工程師)</small>
      `;
    }
  }

  window.selectUser = function(uuid) {
    CURRENT_USER_ID = uuid;
    document.getElementById('loginOverlay').style.display = 'none';
    alert('已登入，現在可以點擊財神馬抽獎了！');
  };

  // 3. 抽獎 (綁定財神馬)
  window.openWealthModal = async function() {
    // 這裡我們把「點擊財神馬」暫時改成「直接抽獎」來測試功能是否正常
    if (!CURRENT_USER_ID) {
      alert("請先重新整理網頁登入！");
      return;
    }

    const modal = document.getElementById('resultModal');
    const text = document.getElementById('prizeText');
    
    // 顯示 Loading
    text.innerText = "祈福中...";
    modal.style.display = 'flex';

    try {
      const { data, error } = await supabase.rpc('draw_cny_prize', { p_user_id: CURRENT_USER_ID });
      
      if (error) throw error;

      if (data.status === 'success') {
        text.innerHTML = data.prize_name + "<br><small style='font-size:0.8rem'>"+data.description+"</small>";
      } else {
        text.innerText = data.message;
      }

    } catch (err) {
      alert("抽獎發生錯誤: " + err.message);
      modal.style.display = 'none';
    }
  };

  initLogin();
</script>
</body>
</html>
